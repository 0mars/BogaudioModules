
#include "BogaudioModules.hpp"

struct Offset : Module {
	enum ParamIds {
		OFFSET_PARAM,
		SCALE_PARAM,
		NUM_PARAMS
	};

	enum InputIds {
		OFFSET_INPUT,
		SCALE_INPUT,
		IN_INPUT,
		NUM_INPUTS
	};

	enum OutputIds {
		OUT_OUTPUT,
		NUM_OUTPUTS
	};

	Offset() : Module(NUM_PARAMS, NUM_INPUTS, NUM_OUTPUTS) {}

	virtual void step() override;

	float knobValue(const Param& knob, const Input& cv) const;
};

void Offset::step() {
	float offset = knobValue(params[OFFSET_PARAM], inputs[OFFSET_INPUT]);
	float scale = knobValue(params[SCALE_PARAM], inputs[SCALE_INPUT]);
	scale = scale < 0.0 ? -pow(scale, 2.0) : pow(scale, 2.0);
	scale *= 10.0;
	if (inputs[IN_INPUT].active) {
		outputs[OUT_OUTPUT].value = clampf((inputs[IN_INPUT].value + 10.0 * offset) * scale, -10.0, 10.0);
	}
	else {
		outputs[OUT_OUTPUT].value = clampf(10.0 * offset * scale, -10.0, 10.0);
	}
}

float Offset::knobValue(const Param& knob, const Input& cv) const {
	float v = clampf(knob.value, -1.0, 1.0);
	if (cv.active) {
		v *= clampf(cv.value / 10.0, -1.0, 1.0);
	}
	return v;
}


OffsetWidget::OffsetWidget() {
	Offset *module = new Offset();
	setModule(module);
	box.size = Vec(RACK_GRID_WIDTH * 3, RACK_GRID_HEIGHT);

	{
		SVGPanel *panel = new SVGPanel();
		panel->box.size = box.size;
		panel->setBackground(SVG::load(assetPlugin(plugin, "res/Offset.svg")));
		addChild(panel);
	}

	addChild(createScrew<ScrewSilver>(Vec(0, 0)));
	addChild(createScrew<ScrewSilver>(Vec(box.size.x - 15, 365)));

	float knobNudge = 0.4;
	// generated by svg_widgets.rb
	auto offsetParamPosition = Vec(7.5 + knobNudge, 39.5 + knobNudge);
	auto scaleParamPosition = Vec(7.5 + knobNudge, 151.5 + knobNudge);

	auto offsetInputPosition = Vec(10.5, 81.0);
	auto scaleInputPosition = Vec(10.5, 193.0);
	auto inInputPosition = Vec(10.5, 243.0);

	auto outOutputPosition = Vec(10.5, 281.0);
	// end generated by svg_widgets.rb

	addParam(createParam<Knob29>(offsetParamPosition, module, Offset::OFFSET_PARAM, -1.0, 1.0, 0.0));
	addParam(createParam<Knob29>(scaleParamPosition, module, Offset::SCALE_PARAM, -1.0, 1.0, 0.316));

	addInput(createInput<PJ301MPort>(offsetInputPosition, module, Offset::OFFSET_INPUT));
	addInput(createInput<PJ301MPort>(scaleInputPosition, module, Offset::SCALE_INPUT));
	addInput(createInput<PJ301MPort>(inInputPosition, module, Offset::IN_INPUT));

	addOutput(createOutput<PJ301MPort>(outOutputPosition, module, Offset::OUT_OUTPUT));
}
